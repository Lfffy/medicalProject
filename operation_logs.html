<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>操作日志 - 医疗数据分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- 浏览器兼容性Polyfill -->
    <script src="static/js/polyfills.js"></script>
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        .log-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .log-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .log-header h2 {
            margin: 0;
            font-weight: bold;
        }
        
        .log-header .breadcrumb {
            background: none;
            margin: 10px 0 0 0;
            padding: 0;
        }
        
        .log-header .breadcrumb-item {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .log-header .breadcrumb-item.active {
            color: white;
        }
        
        .log-header .breadcrumb-item a {
            color: white;
            text-decoration: none;
        }
        
        .log-header .breadcrumb-item a:hover {
            text-decoration: underline;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stat-card.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }
        
        .stat-card.danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
            color: white;
        }
        
        .stat-card .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .filter-bar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .filter-bar .form-control, .filter-bar .form-select {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            padding: 12px 20px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .filter-bar .form-control:focus, .filter-bar .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-outline-primary {
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #764ba2;
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        
        .log-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }
        
        .log-table table {
            margin: 0;
        }
        
        .log-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .log-table td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .log-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .action-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            margin-right: 15px;
        }
        
        .action-icon.login {
            background: #d4edda;
            color: #155724;
        }
        
        .action-icon.logout {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-icon.create {
            background: #cce5ff;
            color: #004085;
        }
        
        .action-icon.edit {
            background: #fff3cd;
            color: #856404;
        }
        
        .action-icon.delete {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-icon.view {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .action-icon.export {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .action-icon.import {
            background: #d4edda;
            color: #155724;
        }
        
        .log-content {
            flex: 1;
        }
        
        .log-action {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .log-details {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .log-ip {
            color: #999;
            font-size: 0.85rem;
        }
        
        .user-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .module-badge {
            background: #e9ecef;
            color: #495057;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .pagination {
            justify-content: center;
            margin-top: 30px;
        }
        
        .pagination .page-link {
            border: none;
            color: #667eea;
            padding: 10px 15px;
            margin: 0 5px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .pagination .page-link:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .pagination .page-item.active .page-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .empty-state h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .loading-spinner {
            display: none;
        }
        
        .btn.loading .btn-text {
            display: none;
        }
        
        .btn.loading .loading-spinner {
            display: inline-block;
        }
        
        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .date-range-picker .form-control {
            flex: 1;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .chart-container h5 {
            margin-bottom: 20px;
            color: #333;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="log-container">
        <!-- 页面头部 -->
        <div class="log-header">
            <h2><i class="fas fa-history"></i> 操作日志</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/index.html">首页</a></li>
                    <li class="breadcrumb-item"><a href="/admin.html">系统管理</a></li>
                    <li class="breadcrumb-item active">操作日志</li>
                </ol>
            </nav>
        </div>
        
        <!-- 统计卡片 -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-icon"><i class="fas fa-list-alt"></i></div>
                <div class="stat-value" id="totalLogs">0</div>
                <div class="stat-label">总日志数</div>
            </div>
            <div class="stat-card success">
                <div class="stat-icon"><i class="fas fa-user-check"></i></div>
                <div class="stat-value" id="todayLogs">0</div>
                <div class="stat-label">今日操作</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-value" id="activeUsers">0</div>
                <div class="stat-label">活跃用户</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-value" id="errorLogs">0</div>
                <div class="stat-label">异常操作</div>
            </div>
        </div>
        
        <!-- 操作统计图表 -->
        <div class="chart-container">
            <h5><i class="fas fa-chart-line"></i> 操作趋势分析</h5>
            <canvas id="operationChart" width="400" height="100"></canvas>
        </div>
        
        <!-- 筛选栏 -->
        <div class="filter-bar">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="searchKeyword" class="form-label">搜索关键词</label>
                    <input type="text" class="form-control" id="searchKeyword" placeholder="搜索用户、模块或操作">
                </div>
                <div class="col-md-2">
                    <label for="actionFilter" class="form-label">操作类型</label>
                    <select class="form-select" id="actionFilter">
                        <option value="">所有操作</option>
                        <option value="login">登录</option>
                        <option value="logout">登出</option>
                        <option value="create">创建</option>
                        <option value="edit">编辑</option>
                        <option value="delete">删除</option>
                        <option value="view">查看</option>
                        <option value="export">导出</option>
                        <option value="import">导入</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="moduleFilter" class="form-label">模块</label>
                    <select class="form-select" id="moduleFilter">
                        <option value="">所有模块</option>
                        <option value="user">用户管理</option>
                        <option value="analysis">数据分析</option>
                        <option value="system">系统管理</option>
                        <option value="report">报表管理</option>
                        <option value="data">数据管理</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">时间范围</label>
                    <div class="date-range-picker">
                        <input type="date" class="form-control" id="startDate">
                        <span>至</span>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <div class="btn-group w-100">
                        <button class="btn btn-primary" onclick="searchLogs()">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <button class="btn btn-success" onclick="exportLogs()">
                            <i class="fas fa-download"></i> 导出
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 日志列表 -->
        <div class="log-table">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>操作信息</th>
                        <th>用户</th>
                        <th>模块</th>
                        <th>IP地址</th>
                        <th>操作时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="logTableBody">
                    <tr>
                        <td colspan="6" class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> 加载中...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 分页 -->
        <nav aria-label="日志列表分页">
            <ul class="pagination" id="pagination">
                <!-- 分页按钮将通过JavaScript动态生成 -->
            </ul>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let currentPage = 1;
        let pageSize = 20;
        let totalLogs = 0;
        let operationChart = null;
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadLogStats();
            loadOperationChart();
            loadLogs();
            
            // 设置默认日期范围（最近7天）
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 7);
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        });
        
        // 检查登录状态
        function checkLoginStatus() {
            const userData = sessionStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = '/login.html';
                return;
            }
            
            try {
                const user = JSON.parse(userData);
                if (user.role !== 'admin' && user.role !== 'manager') {
                    alert('您没有权限访问此页面');
                    window.location.href = '/index.html';
                    return;
                }
            } catch (e) {
                console.error('解析用户数据失败:', e);
                window.location.href = '/login.html';
            }
        }
        
        // 加载日志统计
        async function loadLogStats() {
            try {
                const response = await fetch('/api/logs/stats', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    const stats = result.data;
                    document.getElementById('totalLogs').textContent = stats.total_logs || 0;
                    document.getElementById('todayLogs').textContent = stats.today_logs || 0;
                    document.getElementById('activeUsers').textContent = stats.active_users || 0;
                    document.getElementById('errorLogs').textContent = stats.error_logs || 0;
                }
                
            } catch (error) {
                console.error('加载日志统计失败:', error);
            }
        }
        
        // 加载操作统计图表
        async function loadOperationChart() {
            try {
                const response = await fetch('/api/logs/operation-stats', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    const data = result.data || {};
                    renderOperationChart(data);
                }
                
            } catch (error) {
                console.error('加载操作统计失败:', error);
                // 使用模拟数据
                renderOperationChart({
                    '2024-01-01': 45,
                    '2024-01-02': 52,
                    '2024-01-03': 38,
                    '2024-01-04': 65,
                    '2024-01-05': 48,
                    '2024-01-06': 72,
                    '2024-01-07': 58
                });
            }
        }
        
        // 渲染操作统计图表
        function renderOperationChart(data) {
            const ctx = document.getElementById('operationChart').getContext('2d');
            
            const labels = Object.keys(data).slice(-7); // 最近7天
            const values = labels.map(date => data[date] || 0);
            
            if (operationChart) {
                operationChart.destroy();
            }
            
            operationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(date => {
                        const d = new Date(date);
                        return `${d.getMonth() + 1}/${d.getDate()}`;
                    }),
                    datasets: [{
                        label: '操作次数',
                        data: values,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    }
                }
            });
        }
        
        // 加载日志列表
        async function loadLogs(page = 1) {
            currentPage = page;
            
            const searchKeyword = document.getElementById('searchKeyword').value.trim();
            const actionFilter = document.getElementById('actionFilter').value;
            const moduleFilter = document.getElementById('moduleFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const params = new URLSearchParams({
                page: currentPage,
                page_size: pageSize
            });
            
            if (searchKeyword) params.append('search', searchKeyword);
            if (actionFilter) params.append('action', actionFilter);
            if (moduleFilter) params.append('module', moduleFilter);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            
            try {
                const response = await fetch(`/api/logs/operations?${params}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    const logs = result.data.logs || [];
                    totalLogs = result.data.total || 0;
                    
                    renderLogTable(logs);
                    renderPagination();
                } else {
                    showAlert(result.message || '加载日志列表失败', 'danger');
                }
                
            } catch (error) {
                console.error('加载日志列表失败:', error);
                showAlert('网络错误，请稍后重试', 'danger');
            }
        }
        
        // 渲染日志表格
        function renderLogTable(logs) {
            const tbody = document.getElementById('logTableBody');
            
            if (logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-history"></i>
                                <h4>暂无日志数据</h4>
                                <p>请尝试调整筛选条件</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            logs.forEach(log => {
                html += `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="action-icon ${log.action}">
                                    <i class="fas fa-${getActionIcon(log.action)}"></i>
                                </div>
                                <div class="log-content">
                                    <div class="log-action">${getActionDisplayName(log.action)}</div>
                                    <div class="log-details">${log.description || '无详细描述'}</div>
                                    <div class="log-ip">IP: ${log.ip_address}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="user-badge">${log.username}</span>
                        </td>
                        <td>
                            <span class="module-badge">${getModuleDisplayName(log.module)}</span>
                        </td>
                        <td>${log.ip_address}</td>
                        <td>${formatDateTime(new Date(log.created_at))}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewLogDetail(${log.id})">
                                <i class="fas fa-eye"></i> 详情
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // 渲染分页
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(totalLogs / pageSize);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // 上一页
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadLogs(${currentPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // 页码
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadLogs(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `
                        <li class="page-item disabled">
                            <a class="page-link" href="#">...</a>
                        </li>
                    `;
                }
            }
            
            // 下一页
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadLogs(${currentPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            
            pagination.innerHTML = html;
        }
        
        // 搜索日志
        function searchLogs() {
            loadLogs(1);
        }
        
        // 导出日志
        async function exportLogs() {
            const searchKeyword = document.getElementById('searchKeyword').value.trim();
            const actionFilter = document.getElementById('actionFilter').value;
            const moduleFilter = document.getElementById('moduleFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const params = new URLSearchParams();
            
            if (searchKeyword) params.append('search', searchKeyword);
            if (actionFilter) params.append('action', actionFilter);
            if (moduleFilter) params.append('module', moduleFilter);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            
            try {
                const response = await fetch(`/api/logs/export?${params}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `操作日志_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert('日志导出成功', 'success');
                } else {
                    const result = await response.json();
                    showAlert(result.message || '导出失败', 'danger');
                }
                
            } catch (error) {
                console.error('导出日志失败:', error);
                showAlert('网络错误，请稍后重试', 'danger');
            }
        }
        
        // 查看日志详情
        async function viewLogDetail(logId) {
            try {
                const response = await fetch(`/api/logs/operations/${logId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    const log = result.data;
                    
                    const modalHtml = `
                        <div class="modal fade" id="logDetailModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">日志详情</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>用户名：</strong> ${log.username}
                                            </div>
                                            <div class="col-md-6">
                                                <strong>操作类型：</strong> ${getActionDisplayName(log.action)}
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>模块：</strong> ${getModuleDisplayName(log.module)}
                                            </div>
                                            <div class="col-md-6">
                                                <strong>IP地址：</strong> ${log.ip_address}
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>操作时间：</strong> ${formatDateTime(new Date(log.created_at))}
                                            </div>
                                            <div class="col-md-6">
                                                <strong>用户代理：</strong> ${log.user_agent || '未知'}
                                            </div>
                                        </div>
                                        <hr>
                                        <div>
                                            <strong>操作描述：</strong>
                                            <p class="mt-2">${log.description || '无详细描述'}</p>
                                        </div>
                                        ${log.details ? `
                                            <hr>
                                            <div>
                                                <strong>详细信息：</strong>
                                                <pre class="mt-2 p-3 bg-light rounded">${JSON.stringify(log.details, null, 2)}</pre>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">关闭</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 移除已存在的模态框
                    const existingModal = document.getElementById('logDetailModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // 添加新模态框
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    // 显示模态框
                    const modal = new bootstrap.Modal(document.getElementById('logDetailModal'));
                    modal.show();
                    
                    // 模态框关闭后移除DOM
                    document.getElementById('logDetailModal').addEventListener('hidden.bs.modal', function() {
                        this.remove();
                    });
                    
                } else {
                    showAlert(result.message || '获取日志详情失败', 'danger');
                }
                
            } catch (error) {
                console.error('获取日志详情失败:', error);
                showAlert('网络错误，请稍后重试', 'danger');
            }
        }
        
        // 获取操作图标
        function getActionIcon(action) {
            const iconMap = {
                'login': 'sign-in-alt',
                'logout': 'sign-out-alt',
                'create': 'plus',
                'edit': 'edit',
                'delete': 'trash',
                'view': 'eye',
                'export': 'download',
                'import': 'upload'
            };
            return iconMap[action] || 'circle';
        }
        
        // 获取操作显示名称
        function getActionDisplayName(action) {
            const actionNames = {
                'login': '登录',
                'logout': '登出',
                'create': '创建',
                'edit': '编辑',
                'delete': '删除',
                'view': '查看',
                'export': '导出',
                'import': '导入'
            };
            return actionNames[action] || action;
        }
        
        // 获取模块显示名称
        function getModuleDisplayName(module) {
            const moduleNames = {
                'user': '用户管理',
                'analysis': '数据分析',
                'system': '系统管理',
                'report': '报表管理',
                'data': '数据管理'
            };
            return moduleNames[module] || module;
        }
        
        // 格式化日期时间
        function formatDateTime(date) {
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN');
        }
        
        // 显示提示信息
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // 自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // 搜索框回车事件
        document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLogs();
            }
        });
        
        // 日期变化时自动搜索
        document.getElementById('startDate').addEventListener('change', searchLogs);
        document.getElementById('endDate').addEventListener('change', searchLogs);
    </script>
</body>
</html>